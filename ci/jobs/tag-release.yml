retag-release:
  extends: .runner-tag-release
  stage: tag-release
  image:
    name: gcr.io/go-containerregistry/crane:debug@sha256:e127ad51b30941d51b4cb3c768e3a5b7a3dfe5fbd190821013cd891707145de8
    entrypoint: [""]
  variables:
    RELEASE_TAG_FULL: ${RELEASE_TAG}-${CI_PIPELINE_ID}
    MODULES: >
      pbs-batch-scheduler-web-rest 
      pbs-config 
      pbs-checkout-web-rest
      pbs-checkout-web-ui 
      pbs-compatibility-web-rest 
      pbs-compatibility-web-soap 
      pbs-couponing-web-rest 
      pbs-mapi-adapter
      pbs-payment-web-rest 
      pbs-settlement-web-rest 
      pbs-settlement-documents-web-rest
  needs: [version]
  script:
    - echo "release tag ${RELEASE_TAG}"
    - \[ -z "${RELEASE_TAG}" \] && echo "RELEASE_TAG must be set" && exit 1;
    - crane auth login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - crane auth login -u $MTR_REGISTRY_USER -p $MTR_REGISTRY_PASSWORD $MTR_CI_REGISTRY
    - |
      for MODULE in ${MODULES}
      do
        crane cp ${CI_REGISTRY_IMAGE}/${MODULE}:${IMAGE_TAG} ${CI_REGISTRY_IMAGE}/${MODULE}:${RELEASE_TAG_FULL}
        crane cp ${CI_REGISTRY_IMAGE}/${MODULE}:${IMAGE_TAG} ${MTR_CI_REGISTRY_IMAGE}/${MODULE}:${RELEASE_TAG_FULL}
      done